<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Helmet Intercom</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-user-select: none;
            user-select: none;
        }
        .container { max-width: 400px; width: 100%; }
        .header { text-align: center; margin-bottom: 30px; }
        .icon { font-size: 64px; margin-bottom: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        h1 { font-size: 32px; margin-bottom: 5px; }
        .subtitle { color: #a0a0a0; font-size: 14px; }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-label { color: #a0a0a0; }
        .status-value { display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #666; }
        .status-dot.connected { background: #10b981; animation: pulse 2s infinite; }
        .status-message {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            font-size: 14px;
        }
        .error-icon { color: #ef4444; flex-shrink: 0; }
        button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        button:active { transform: scale(0.98); }
        .btn-driver { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-pillion { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-mute { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-unmute { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px; padding: 15px; }
        .instructions {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 15px;
            padding: 20px;
        }
        .instructions h3 { display: flex; align-items: center; gap: 8px; color: #60a5fa; margin-bottom: 15px; font-size: 16px; }
        .instructions ol { padding-left: 20px; font-size: 14px; line-height: 1.8; color: #d1d5db; }
        .instructions li { margin-bottom: 8px; }
        .instructions strong { color: white; }
        .hidden { display: none !important; }
        .emoji { font-size: 24px; }
        input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            text-align: center;
            font-family: monospace;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon">üì°</div>
            <h1>Helmet Intercom</h1>
            <p class="subtitle">Always-On Voice Link</p>
        </div>
        <div class="card">
            <div class="status-row">
                <span class="status-label">Status:</span>
                <div class="status-value">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Offline</span>
                </div>
            </div>
            <div class="status-message" id="statusMsg">Choose your position</div>
            <div id="codeDisplay" class="hidden" style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="text-align: center; margin-bottom: 8px; color: #10b981; font-weight: 600; font-size: 12px;">üîê SECURE SESSION CODE</div>
                <div id="sessionCode" style="text-align: center; font-family: monospace; font-size: 18px; font-weight: bold; letter-spacing: 2px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;"></div>
                <div style="text-align: center; margin-top: 8px; color: #a0a0a0; font-size: 11px;">Share this code with your pillion only</div>
            </div>
            <div id="error" class="error hidden">
                <span class="error-icon">‚ö†Ô∏è</span>
                <span id="errorText"></span>
            </div>
            <div id="setupScreen">
                <button class="btn-driver" onclick="app.startDriver()">
                    <span class="emoji">üèçÔ∏è</span>
                    <span>DRIVER (Create Room)</span>
                </button>
                <div style="text-align: center; margin: 15px 0; color: #666; font-size: 14px;">OR</div>
                <div style="margin-bottom: 10px;">
                    <input type="text" id="joinCode" placeholder="Enter room code from driver" />
                </div>
                <button class="btn-pillion" onclick="app.startPillion()">
                    <span class="emoji">üë§</span>
                    <span>PILLION (Join Room)</span>
                </button>
            </div>
            <div id="waitingScreen" class="hidden">
                <button class="btn-secondary" onclick="app.cancel()">Cancel</button>
            </div>
            <div id="dashboard" class="hidden">
                <button id="muteBtn" class="btn-mute" onclick="app.toggleMute()">
                    <span id="muteIcon" class="emoji">üé§</span>
                    <span id="muteText">MUTE</span>
                </button>
                <button class="btn-secondary" onclick="app.endSession()">End Session</button>
            </div>
        </div>
        <div class="instructions">
            <h3><span>‚ÑπÔ∏è</span><span>Quick Start</span></h3>
            <ol>
                <li><strong>Driver</strong>: Turn on Personal Hotspot</li>
                <li><strong>Pillion</strong>: Connect to hotspot WiFi</li>
                <li><strong>Driver</strong>: Tap "Create Room" to get a code</li>
                <li><strong>Driver</strong>: Share code with pillion</li>
                <li><strong>Pillion</strong>: Enter code and tap "Join Room"</li>
                <li>Allow microphone - Ride safe! üèîÔ∏è</li>
            </ol>
        </div>
    </div>
    <script>
        const app = {
            state: {
                connected: false,
                muted: false,
                role: null,
                code: null,
                peer: null,
                call: null,
                localStream: null,
                remoteStream: null,
                audioContext: null,
                audioElements: [],
                originalVolumes: new Map()
            },
            init() {
                this.setupAudioContext();
                this.setupBackgroundKeepAlive();
                document.getElementById('joinCode').addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                });
            },
            generateCode() {
                const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                const digits = Math.floor(1000 + Math.random() * 9000);
                return letter + digits;
            },
            setupAudioContext() {
                try {
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.state.audioContext.onstatechange = () => {
                        if (this.state.audioContext.state === 'suspended' && this.state.connected) {
                            this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                        }
                    };
                    setInterval(() => this.monitorAudioElements(), 3000);
                } catch (error) {
                    console.error('Audio context setup failed:', error);
                }
            },
            monitorAudioElements() {
                const allMedia = document.querySelectorAll('audio:not([data-dhvani]), video');
                allMedia.forEach(element => {
                    if (!this.state.audioElements.includes(element)) {
                        this.state.audioElements.push(element);
                        if (!this.state.originalVolumes.has(element)) {
                            this.state.originalVolumes.set(element, element.volume);
                            element.volume = Math.max(0, Math.min(1, element.volume * 0.8));
                        }
                    }
                });
            },
            async startDriver() {
                try {
                    console.log('üèçÔ∏è Starting as DRIVER...');
                    this.hideError();
                    document.getElementById('statusMsg').textContent = 'Requesting microphone...';
                    this.showScreen('waitingScreen');
                    this.state.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { sampleRate: 44100, echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                    });
                    console.log('‚úÖ Microphone access granted');
                    this.state.code = this.generateCode();
                    this.state.role = 'driver';
                    document.getElementById('sessionCode').textContent = this.state.code;
                    document.getElementById('codeDisplay').classList.remove('hidden');
                    document.getElementById('statusMsg').textContent = 'Waiting for pillion to connect...';
                    const peerId = `helmet-${this.state.code}-driver`;
                    this.state.peer = new Peer(peerId, {
                        debug: 2,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ],
                            iceKeepAliveInterval: 3000
                        }
                    });
                    this.state.peer.on('open', () => {
                        console.log('‚úÖ DRIVER peer opened');
                    });
                    this.state.peer.on('call', (call) => {
                        console.log('üìû Incoming call');
                        document.getElementById('statusMsg').textContent = 'Pillion joining...';
                        call.answer(this.state.localStream);
                        call.on('stream', (remoteStream) => {
                            console.log('‚úÖ Remote stream received');
                            this.handleRemoteStream(remoteStream);
                            this.state.call = call;
                        });
                        call.on('close', () => {
                            console.log('‚ùå Call closed');
                            this.showError('Connection lost');
                            this.endSession();
                        });
                        call.on('error', (error) => console.error('‚ùå Call error:', error));
                    });
                    this.state.peer.on('error', (error) => {
                        console.error('‚ùå Peer error:', error);
                        this.showError('Connection error: ' + error.type);
                    });
                    this.state.peer.on('disconnected', () => {
                        console.warn('‚ö†Ô∏è Peer disconnected, reconnecting...');
                        setTimeout(() => {
                            if (this.state.peer && !this.state.peer.destroyed) {
                                this.state.peer.reconnect();
                            }
                        }, 3000);
                    });
                } catch (error) {
                    console.error('‚ùå Driver start error:', error);
                    this.showError('Failed to start: ' + error.message);
                    this.cancel();
                }
            },
            async startPillion() {
                try {
                    console.log('üë§ Starting as PILLION...');
                    this.hideError();
                    const code = document.getElementById('joinCode').value.trim().toUpperCase();
                    if (!code.match(/^[A-Z]\d{4}$/)) {
                        this.showError('Enter a valid 5-character code (e.g., A1234)');
                        return;
                    }
                    document.getElementById('statusMsg').textContent = 'Requesting microphone...';
                    this.showScreen('waitingScreen');
                    this.state.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { sampleRate: 44100, echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                    });
                    console.log('‚úÖ Microphone access granted');
                    this.state.code = code;
                    this.state.role = 'pillion';
                    document.getElementById('statusMsg').textContent = 'Connecting to driver...';
                    const peerId = `helmet-${code}-pillion-${Date.now()}`;
                    this.state.peer = new Peer(peerId, {
                        debug: 2,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ],
                            iceKeepAliveInterval: 3000
                        }
                    });
                    this.state.peer.on('open', () => {
                        console.log('‚úÖ PILLION peer opened');
                        setTimeout(() => {
                            const driverId = `helmet-${code}-driver`;
                            const call = this.state.peer.call(driverId, this.state.localStream);
                            if (!call) {
                                this.showError('Could not reach driver.');
                                return;
                            }
                            this.state.call = call;
                            call.on('stream', (remoteStream) => {
                                console.log('‚úÖ Remote stream received');
                                this.handleRemoteStream(remoteStream);
                            });
                            call.on('close', () => {
                                console.log('‚ùå Call closed');
                                this.showError('Connection lost');
                                this.endSession();
                            });
                            call.on('error', (error) => {
                                console.error('‚ùå Call error:', error);
                                this.showError('Connection failed: ' + error.message);
                            });
                        }, 2000);
                    });
                    this.state.peer.on('error', (error) => {
                        console.error('‚ùå Peer error:', error);
                        this.showError(error.type === 'peer-unavailable' ? 
                            'Driver not found. Check code.' : 'Connection error: ' + error.type);
                    });
                    this.state.peer.on('disconnected', () => {
                        console.warn('‚ö†Ô∏è Peer disconnected, reconnecting...');
                        setTimeout(() => {
                            if (this.state.peer && !this.state.peer.destroyed) {
                                this.state.peer.reconnect();
                            }
                        }, 3000);
                    });
                } catch (error) {
                    console.error('‚ùå Pillion start error:', error);
                    this.showError('Failed to connect: ' + error.message);
                    this.cancel();
                }
            },
            handleRemoteStream(stream) {
                console.log('üéµ Setting up remote audio...');
                this.state.remoteStream = stream;
                const audio = new Audio();
                audio.srcObject = stream;
                audio.setAttribute('data-dhvani', 'true');
                audio.playsinline = true;
                const gainNode = this.state.audioContext.createGain();
                gainNode.gain.value = 1.25; // Boost for 25% louder
                const source = this.state.audioContext.createMediaStreamSource(stream);
                source.connect(gainNode);
                gainNode.connect(this.state.audioContext.destination);
                const playAudio = () => {
                    this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                    audio.play()
                        .then(() => console.log('‚úÖ Remote audio playing'))
                        .catch(err => {
                            console.error('‚ùå Audio playback error:', err);
                            const btn = document.createElement('button');
                            btn.textContent = 'Resume Audio';
                            btn.style.position = 'fixed';
                            btn.style.top = '10px';
                            btn.style.left = '50%';
                            btn.style.transform = 'translateX(-50%)';
                            btn.style.padding = '10px 20px';
                            btn.style.background = '#10b981';
                            btn.style.color = 'white';
                            btn.style.borderRadius = '8px';
                            btn.onclick = () => {
                                audio.play().then(() => btn.remove());
                            };
                            document.body.appendChild(btn);
                        });
                };
                playAudio();
                document.body.addEventListener('click', playAudio, { once: true });
                document.body.addEventListener('touchstart', playAudio, { once: true });
                this.state.connected = true;
                document.getElementById('statusMsg').textContent = 'üéôÔ∏è INTERCOM ACTIVE';
                document.getElementById('statusText').textContent = 'Live';
                document.getElementById('statusDot').classList.add('connected');
                this.showScreen('dashboard');
                this.monitorAudioElements();
            },
            setupBackgroundKeepAlive() {
                setInterval(() => {
                    if (this.state.connected && this.state.peer && !this.state.peer.destroyed) {
                        this.state.peer.reconnect();
                    }
                    if (this.state.audioContext && this.state.audioContext.state === 'suspended') {
                        this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                    }
                    if (this.state.localStream && !this.state.muted) {
                        this.state.localStream.getAudioTracks().forEach(track => track.enabled = true);
                    }
                    if (this.state.remoteStream) {
                        const audio = document.querySelector('audio[data-dhvani]');
                        if (audio && audio.paused) {
                            audio.play().catch(err => console.error('Audio resume failed:', err));
                        }
                    }
                }, 3000);
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.state.connected) {
                        if (this.state.audioContext) {
                            this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                        }
                        if (this.state.localStream && !this.state.muted) {
                            this.state.localStream.getAudioTracks().forEach(track => track.enabled = true);
                        }
                        if (this.state.remoteStream) {
                            const audio = document.querySelector('audio[data-dhvani]');
                            if (audio && audio.paused) {
                                audio.play().catch(err => console.error('Audio resume failed:', err));
                            }
                        }
                    }
                });
            },
            toggleMute() {
                this.state.muted = !this.state.muted;
                if (this.state.localStream) {
                    this.state.localStream.getAudioTracks().forEach(track => track.enabled = !this.state.muted);
                }
                const icon = document.getElementById('muteIcon');
                const text = document.getElementById('muteText');
                const btn = document.getElementById('muteBtn');
                icon.textContent = this.state.muted ? 'üîá' : 'üé§';
                text.textContent = this.state.muted ? 'UNMUTE' : 'MUTE';
                btn.className = this.state.muted ? 'btn-unmute' : 'btn-mute';
            },
            cancel() {
                this.cleanup();
                this.showScreen('setupScreen');
                document.getElementById('statusMsg').textContent = 'Choose your position';
                document.getElementById('statusText').textContent = 'Offline';
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('codeDisplay').classList.add('hidden');
                document.getElementById('joinCode').value = '';
            },
            endSession() {
                if (confirm('End this session?')) {
                    this.cleanup();
                    this.showScreen('setupScreen');
                    document.getElementById('statusMsg').textContent = 'Choose your position';
                    document.getElementById('statusText').textContent = 'Offline';
                    document.getElementById('statusDot').classList.remove('connected');
                    document.getElementById('codeDisplay').classList.add('hidden');
                    document.getElementById('joinCode').value = '';
                }
            },
            cleanup() {
                if (this.state.localStream) {
                    this.state.localStream.getTracks().forEach(track => track.stop());
                    this.state.localStream = null;
                }
                if (this.state.remoteStream) {
                    this.state.remoteStream.getTracks().forEach(track => track.stop());
                    this.state.remoteStream = null;
                }
                if (this.state.call) {
                    this.state.call.close();
                    this.state.call = null;
                }
                if (this.state.peer) {
                    this.state.peer.destroy();
                    this.state.peer = null;
                }
                if (this.state.audioContext) {
                    this.state.audioContext.close();
                    this.state.audioContext = null;
                }
                this.state.audioElements.forEach(element => {
                    element.volume = this.state.originalVolumes.get(element) || 1.0;
                });
                this.state.connected = false;
                this.state.muted = false;
                this.state.code = null;
                this.state.role = null;
                this.state.audioElements = [];
                this.state.originalVolumes.clear();
            },
            showScreen(screenId) {
                ['setupScreen', 'waitingScreen', 'dashboard'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            showError(msg) {
                const errorEl = document.getElementById('error');
                errorEl.classList.remove('hidden');
                document.getElementById('errorText').textContent = msg;
                setTimeout(() => this.hideError(), 5000);
            },
            hideError() {
                document.getElementById('error').classList.add('hidden');
            }
        };
        app.init();
        window.addEventListener('beforeunload', (e) => {
            if (app.state.connected) {
                e.preventDefault();
                e.returnValue = 'You have an active connection';
            }
        });
    </script>
</body>
</html>
