<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dhvani-WT</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,140,0,0.03) 35px, rgba(255,140,0,0.03) 70px), radial-gradient(circle at 20% 50%, rgba(255,165,0,0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
        .container { max-width: 500px; width: 100%; position: relative; z-index: 1; }
        .screen { background: #fff; color: #000; border-radius: 30px; min-height: 600px; box-shadow: 0 30px 80px rgba(0,0,0,0.9); position: relative; overflow: hidden; }
        .status-bar { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-size: 14px; font-weight: 500; }
        .content { padding: 0 24px 30px; }
        .hero { text-align: center; padding: 60px 0 50px; }
        .app-name { font-size: 42px; font-weight: 700; margin-bottom: 8px; letter-spacing: 3px; }
        .app-subtitle { font-size: 13px; color: #666; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; }
        .btn { width: 100%; height: 64px; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; margin-bottom: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #000; color: #fff; }
        .btn-secondary { background: #f5f5f5; color: #000; }
        .divider { text-align: center; margin: 24px 0; color: #999; font-size: 14px; position: relative; }
        .divider::before, .divider::after { content: ''; position: absolute; top: 50%; width: 42%; height: 1px; background: #e0e0e0; }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        .input { width: 100%; height: 70px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 32px; text-align: center; font-family: monospace; letter-spacing: 8px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; outline: none; }
        .input:focus { border-color: #000; background: #fff; }
        .card { background: #000; color: #fff; border-radius: 16px; padding: 24px; margin-bottom: 20px; }
        .status-live { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; color: #00d66b; }
        .dot { width: 8px; height: 8px; background: #00d66b; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .big-num { font-size: 60px; font-weight: 700; line-height: 1; margin: 12px 0; }
        .sub { font-size: 15px; color: #999; }
        .hidden { display: none !important; }
        .error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 12px; padding: 16px; margin-bottom: 20px; color: #ef4444; font-size: 14px; }
        .code-display { background: #f5f5f5; border-radius: 12px; padding: 30px 20px; text-align: center; margin-bottom: 20px; }
        .code { font-size: 56px; font-family: monospace; letter-spacing: 12px; font-weight: 700; color: #000; margin: 20px 0; }
        .note { text-align: center; font-size: 12px; color: #999; margin-top: 12px; }
        .status-msg { background: #f0f0f0; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen">
            <div class="status-bar">
                <span id="time">9:41</span>
                <span>‚óè‚óè‚óè‚óè</span>
            </div>
            <div class="content">
                <div id="setupScreen">
                    <div class="hero">
                        <div class="app-name">DHVANI-WT</div>
                        <div class="app-subtitle">Always-On Voice</div>
                    </div>
                    <button class="btn btn-primary" id="hostBtn" onclick="app.startHost()">
                        <span style="font-size: 24px;">üìç</span>
                        <span>Host</span>
                    </button>
                    <div class="divider">or</div>
                    <input type="text" id="joinCode" class="input" placeholder="A1234" maxlength="5">
                    <button class="btn btn-secondary" id="joinBtn" onclick="app.startJoin()">
                        <span style="font-size: 24px;">üîó</span>
                        <span>Join</span>
                    </button>
                    <div id="error" class="error hidden"></div>
                </div>
                <div id="codeScreen" class="hidden">
                    <div class="code-display">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">üîê Your Session Code</div>
                        <div class="code" id="sessionCode">B4729</div>
                        <div class="note">Share this code with your partner</div>
                    </div>
                    <div class="status-msg" id="statusMsg">Waiting for partner to connect...</div>
                    <button class="btn btn-secondary" onclick="app.cancel()">Cancel</button>
                </div>
                <div id="dashboard" class="hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #999; text-transform: uppercase; letter-spacing: 1px;">Battery</span>
                            <div class="status-live">
                                <span class="dot"></span>
                                <span>LIVE</span>
                            </div>
                        </div>
                        <div class="big-num" id="battery">--</div>
                        <div class="sub" id="batteryTime">Calculating...</div>
                    </div>
                    <button class="btn btn-primary" id="muteBtn" onclick="app.toggleMute()">
                        <span id="muteIcon">üé§</span>
                        <span id="muteText">Mute</span>
                    </button>
                    <button class="btn btn-secondary" onclick="app.endSession()">End Session</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const app = {
            state: {
                connected: false,
                muted: false,
                role: null,
                code: null,
                peer: null,
                call: null,
                localStream: null,
                remoteStream: null,
                battery: null,
                audioContext: null,
                audioElements: [],
                originalVolumes: new Map()
            },
            init() {
                this.updateTime();
                setInterval(() => this.updateTime(), 60000);
                this.initBatteryMonitor();
                this.setupAudioContext();
                this.setupBackgroundKeepAlive();
                document.getElementById('joinCode').addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase();
                });
            },
            updateTime() {
                const now = new Date();
                document.getElementById('time').textContent = 
                    now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
            },
            generateCode() {
                const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                const digits = Math.floor(1000 + Math.random() * 9000);
                return letter + digits;
            },
            async initBatteryMonitor() {
                console.log('üîã Initializing battery monitor...');
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        console.log('‚úÖ Battery API available');
                        this.state.battery = battery;
                        this.updateBatteryDisplay();
                        battery.addEventListener('levelchange', () => this.updateBatteryDisplay());
                        battery.addEventListener('chargingchange', () => this.updateBatteryDisplay());
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Battery API error:', error);
                        this.state.battery = { level: 0.85, charging: false };
                        this.updateBatteryDisplay();
                    }
                } else {
                    console.warn('‚ö†Ô∏è Battery API not supported');
                    this.state.battery = { level: 0.85, charging: false };
                    this.updateBatteryDisplay();
                    setInterval(() => {
                        if (this.state.connected && this.state.battery.level > 0.1) {
                            this.state.battery.level = Math.max(0.1, this.state.battery.level - 0.0033);
                            this.updateBatteryDisplay();
                        }
                    }, 60000);
                }
            },
            updateBatteryDisplay() {
                if (!this.state.battery) return;
                const percent = Math.round(this.state.battery.level * 100);
                const hoursLeft = percent / 20;
                const hours = Math.floor(hoursLeft);
                const mins = Math.round((hoursLeft - hours) * 60);
                document.getElementById('battery').textContent = percent + '%';
                document.getElementById('batteryTime').textContent = 
                    this.state.battery.charging ? 'Charging' : 
                    hours > 0 ? `${hours}h ${mins}m remaining` : `${mins}m remaining`;
            },
            setupAudioContext() {
                try {
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.state.audioContext.onstatechange = () => {
                        if (this.state.audioContext.state === 'suspended' && this.state.connected) {
                            this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                        }
                    };
                    setInterval(() => this.monitorAudioElements(), 1000);
                } catch (error) {
                    console.error('Audio context setup failed:', error);
                }
            },
            monitorAudioElements() {
                const allMedia = document.querySelectorAll('audio, video');
                allMedia.forEach(element => {
                    if (!this.state.audioElements.includes(element)) {
                        this.state.audioElements.push(element);
                        if (!this.state.originalVolumes.has(element)) {
                            this.state.originalVolumes.set(element, element.volume);
                            element.volume = Math.max(0, Math.min(1, element.volume * 0.8)); // 25% quieter
                        }
                    }
                });
            },
            async startHost() {
                try {
                    console.log('üé§ Starting as HOST...');
                    this.hideError();
                    document.getElementById('hostBtn').disabled = true;
                    document.getElementById('hostBtn').textContent = 'Starting...';
                    this.state.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
                    });
                    console.log('‚úÖ Microphone access granted');
                    this.state.code = this.generateCode();
                    this.state.role = 'host';
                    document.getElementById('sessionCode').textContent = this.state.code;
                    this.showScreen('codeScreen');
                    const peerId = `dhvani-${this.state.code}-host`;
                    this.state.peer = new Peer(peerId, {
                        debug: 2,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ],
                            iceKeepAliveInterval: 1000
                        }
                    });
                    this.state.peer.on('open', () => {
                        console.log('‚úÖ HOST peer connection opened');
                        document.getElementById('statusMsg').textContent = 'Ready! Waiting for partner...';
                    });
                    this.state.peer.on('call', (call) => {
                        console.log('üìû Incoming call received');
                        document.getElementById('statusMsg').textContent = 'Partner joining...';
                        call.answer(this.state.localStream);
                        call.on('stream', (remoteStream) => {
                            console.log('‚úÖ Remote stream received');
                            this.handleRemoteStream(remoteStream);
                            this.state.call = call;
                        });
                        call.on('close', () => {
                            console.log('‚ùå Call closed');
                            this.showError('Connection lost');
                        });
                        call.on('error', (error) => console.error('‚ùå Call error:', error));
                    });
                    this.state.peer.on('error', (error) => {
                        console.error('‚ùå Peer error:', error);
                        this.showError('Connection error: ' + error.type);
                    });
                    this.state.peer.on('disconnected', () => {
                        console.warn('‚ö†Ô∏è Peer disconnected, attempting reconnect...');
                        setTimeout(() => {
                            if (this.state.peer && !this.state.peer.destroyed) {
                                this.state.peer.reconnect();
                            }
                        }, 1000);
                    });
                } catch (error) {
                    console.error('‚ùå Start host error:', error);
                    this.showError('Failed to start: ' + error.message);
                    this.cancel();
                }
            },
            async startJoin() {
                try {
                    console.log('üîó Starting as JOIN...');
                    this.hideError();
                    const code = document.getElementById('joinCode').value.trim().toUpperCase();
                    if (!code.match(/^[A-Z]\d{4}$/)) {
                        console.error('‚ùå Invalid code format');
                        this.showError('Please enter a valid 5-character code (e.g., A1234)');
                        return;
                    }
                    document.getElementById('joinBtn').disabled = true;
                    document.getElementById('joinBtn').textContent = 'Connecting...';
                    this.state.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
                    });
                    console.log('‚úÖ Microphone access granted');
                    this.state.code = code;
                    this.state.role = 'join';
                    document.getElementById('statusMsg').textContent = 'Connecting to host...';
                    this.showScreen('codeScreen');
                    const peerId = `dhvani-${code}-join-${Date.now()}`;
                    this.state.peer = new Peer(peerId, {
                        debug: 2,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ],
                            iceKeepAliveInterval: 1000
                        }
                    });
                    this.state.peer.on('open', () => {
                        console.log('‚úÖ JOIN peer connection opened');
                        setTimeout(() => {
                            const hostId = `dhvani-${code}-host`;
                            const call = this.state.peer.call(hostId, this.state.localStream);
                            if (!call) {
                                console.error('‚ùå Failed to create call');
                                this.showError('Could not reach host.');
                                return;
                            }
                            this.state.call = call;
                            call.on('stream', (remoteStream) => {
                                console.log('‚úÖ Remote stream received');
                                this.handleRemoteStream(remoteStream);
                            });
                            call.on('close', () => {
                                console.log('‚ùå Call closed');
                                this.showError('Connection lost');
                            });
                            call.on('error', (error) => {
                                console.error('‚ùå Call error:', error);
                                this.showError('Connection failed: ' + error.message);
                            });
                        }, 2000);
                    });
                    this.state.peer.on('error', (error) => {
                        console.error('‚ùå Peer error:', error);
                        this.showError(error.type === 'peer-unavailable' ? 
                            'Host not found. Check code.' : 'Connection error: ' + error.type);
                    });
                    this.state.peer.on('disconnected', () => {
                        console.warn('‚ö†Ô∏è Peer disconnected, attempting reconnect...');
                        setTimeout(() => {
                            if (this.state.peer && !this.state.peer.destroyed) {
                                this.state.peer.reconnect();
                            }
                        }, 1000);
                    });
                } catch (error) {
                    console.error('‚ùå Start join error:', error);
                    this.showError('Failed to connect: ' + error.message);
                    this.cancel();
                }
            },
            handleRemoteStream(stream) {
                console.log('üéµ Setting up remote audio playback...');
                this.state.remoteStream = stream;
                const audio = new Audio();
                audio.srcObject = stream;
                audio.volume = 1.0;
                audio.playsinline = true;
                const playAudio = () => {
                    this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                    audio.play()
                        .then(() => console.log('‚úÖ Remote audio playing'))
                        .catch(err => {
                            console.error('‚ùå Audio playback error:', err);
                            const btn = document.createElement('button');
                            btn.textContent = 'Resume Audio';
                            btn.style.position = 'fixed';
                            btn.style.top = '10px';
                            btn.style.left = '50%';
                            btn.style.transform = 'translateX(-50%)';
                            btn.onclick = () => {
                                audio.play().then(() => btn.remove());
                            };
                            document.body.appendChild(btn);
                        });
                };
                playAudio();
                document.body.addEventListener('click', playAudio, { once: true });
                document.body.addEventListener('touchstart', playAudio, { once: true });
                this.state.connected = true;
                console.log('‚úÖ CONNECTION ESTABLISHED!');
                this.showScreen('dashboard');
                this.updateBatteryDisplay();
                this.monitorAudioElements();
                console.log('üéâ All systems ready!');
            },
            setupBackgroundKeepAlive() {
                setInterval(() => {
                    if (this.state.connected && this.state.peer && !this.state.peer.destroyed) {
                        this.state.peer.reconnect();
                    }
                    if (this.state.audioContext && this.state.audioContext.state === 'suspended') {
                        this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                    }
                    if (this.state.localStream && !this.state.muted) {
                        this.state.localStream.getAudioTracks().forEach(track => track.enabled = true);
                    }
                }, 1000);
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.state.connected) {
                        if (this.state.audioContext) {
                            this.state.audioContext.resume().catch(err => console.error('Audio context resume failed:', err));
                        }
                        if (this.state.localStream && !this.state.muted) {
                            this.state.localStream.getAudioTracks().forEach(track => track.enabled = true);
                        }
                    }
                });
            },
            toggleMute() {
                this.state.muted = !this.state.muted;
                if (this.state.localStream) {
                    this.state.localStream.getAudioTracks().forEach(track => track.enabled = !this.state.muted);
                }
                const icon = document.getElementById('muteIcon');
                const text = document.getElementById('muteText');
                const btn = document.getElementById('muteBtn');
                icon.textContent = this.state.muted ? 'üîá' : 'üé§';
                text.textContent = this.state.muted ? 'Unmute' : 'Mute';
                btn.style.background = this.state.muted ? '#ef4444' : '#000';
            },
            cancel() {
                this.cleanup();
                this.showScreen('setupScreen');
                document.getElementById('hostBtn').disabled = false;
                document.getElementById('hostBtn').innerHTML = '<span style="font-size: 24px;">üìç</span><span>Host</span>';
                document.getElementById('joinBtn').disabled = false;
                document.getElementById('joinBtn').innerHTML = '<span style="font-size: 24px;">üîó</span><span>Join</span>';
            },
            endSession() {
                if (confirm('End this session?')) {
                    this.cleanup();
                    this.showScreen('setupScreen');
                    document.getElementById('joinCode').value = '';
                }
            },
            cleanup() {
                if (this.state.localStream) {
                    this.state.localStream.getTracks().forEach(track => track.stop());
                    this.state.localStream = null;
                }
                if (this.state.remoteStream) {
                    this.state.remoteStream.getTracks().forEach(track => track.stop());
                    this.state.remoteStream = null;
                }
                if (this.state.call) {
                    this.state.call.close();
                    this.state.call = null;
                }
                if (this.state.peer) {
                    this.state.peer.destroy();
                    this.state.peer = null;
                }
                if (this.state.audioContext) {
                    this.state.audioContext.close();
                    this.state.audioContext = null;
                }
                this.state.audioElements.forEach(element => {
                    element.volume = this.state.originalVolumes.get(element) || 1.0;
                });
                this.state.connected = false;
                this.state.muted = false;
                this.state.code = null;
                this.state.role = null;
                this.state.audioElements = [];
                this.state.originalVolumes.clear();
            },
            showScreen(screenId) {
                ['setupScreen', 'codeScreen', 'dashboard'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            showError(msg) {
                const errorEl = document.getElementById('error');
                errorEl.textContent = msg;
                errorEl.classList.remove('hidden');
                setTimeout(() => this.hideError(), 5000);
            },
            hideError() {
                document.getElementById('error').classList.add('hidden');
            }
        };
        app.init();
        window.addEventListener('beforeunload', (e) => {
            if (app.state.connected) {
                e.preventDefault();
                e.returnValue = 'You have an active connection';
            }
        });
    </script>
</body>
</html>
